# LR 1 "ИИС" **Капкин Е.В А-01м-23**

## **Описание проекта:**
Цель данного проекта — создание модели для прогнозирования цен на подержанные автомобили с использованием реальных данных. Проект анализирует различные факторы, влияющие на цену продажи, такие как тип топлива, пробег, возраст автомобиля и тип трансмиссии. Для выполнения задачи используется набор данных [Car Price Prediction][def], предоставляющий информацию о характеристиках и ценах на автомобили. Модель поможет определить основные факторы, влияющие на стоимость подержанных автомобилей и спрогнозировать их цену.

## **Исследование данных:**
Результаты анализа находятся в `./eda/eda.ipynb`. Основные выводы:
- Значительное влияние на цену оказывает тип топлива, особенно для бензиновых и дизельных автомобилей.
- Пробег автомобиля является важным фактором при определении его текущей стоимости.
- Автомобили с автоматической коробкой передач чаще всего имеют более высокую цену продажи.
- Цена продажи также зависит от возраста автомобиля, с заметным снижением для более старых машин.
- Значения текущей цены (Present_Price) распределены в широком диапазоне, что говорит о разнообразии предлагаемых автомобилей.

# MLFlow Project for Car Price Prediction

## Описание проекта

Проект посвящён прогнозированию цен на автомобили с использованием моделей машинного обучения. В ходе исследования проводились эксперименты с различными моделями и их параметрами. Оптимальные результаты достигнуты с помощью `RandomForestRegressor` и автоматического подбора гиперпараметров с использованием библиотеки `Optuna`.

## **Запуск:**
git clone https://github.com/gorg20121/LR1_IIS/   клонирование репозитория

cd LR1_IIS   переход в папку проекта

python -m venv my_venv   создание виртуального окружения

source my_venv/bin/activate   активация окружения (или ..venv\Scripts\activate для Windows)

pip install -r requirements.txt   установка зависимостей


## Запуск MLFlow

Для запуска MLFlow Tracking Server используйте следующую команду:

mlflow ui --backend-store-uri sqlite:///mlflow.db --host 127.0.0.1 --port 5001

MLFlow UI будет доступен по адресу: http://127.0.0.1:5001

Результаты исследования

Лучшая модель

Лучшая модель, основанная на Random Forest, показала следующие результаты:
	mae: 0.61
    mape: 0.24
    mse: 1.01


Выбранные признаки

После применения SequentialFeatureSelector были отобраны следующие признаки:
	•	Present_Price
	•	Driven_kms
	•	Полиномиальные признаки для Present_Price и Driven_kms

Run ID лучшего эксперимента

	•	Run ID: c500265b9eb94feb95050f7df2317783

Модель была зарегистрирована как версия v3 в MLFlow Model Registry с именем Random Forest with OneHotEncoder .

Файлы проекта

	•	model_training.py: Основной скрипт для обучения и логирования модели.
	•	requirements.txt: Зависимости для проекта.
	•	.gitignore: Игнорируемые файлы и директории.
	•	README.md: Описание проекта, инструкции по установке и запуску.

Использование

	1.	Запустите MLFlow Tracking Server.
	2.	Запустите скрипт model_training.py для обучения модели и логирования результатов.
	3.	Анализируйте результаты через MLFlow UI.


[def]: https://www.kaggle.com/datasets/vijayaadithyanvg/car-price-predictionused-cars/data








# ML Service

Это микросервис для работы с моделью машинного обучения, реализованный с использованием **FastAPI**. Сервис принимает запросы на предсказание и возвращает результаты на основе обученной модели.

---

## Структура проекта

### Папка `ml_service`
Содержит исходный код приложения:
- **`main.py`**: основной файл приложения FastAPI. В нем определены эндпоинты.
- **`api_handler.py`**: вспомогательный модуль, который загружает модель и выполняет предсказания.
- **`Dockerfile`**: описание Docker-образа для развертывания сервиса.
- **`requirements.txt`**: список Python-зависимостей для работы сервиса.

### Папка `models`
Директория для хранения модели машинного обучения. Сюда нужно поместить предобученную модель (например, `model.pkl`), чтобы сервис мог использовать ее для предсказаний.

---

## Команды для работы с Docker

### Сборка Docker-образа
Выполните следующую команду для создания Docker-образа:
```bash
docker build -t ml_service .
```

### Запуск Docker-контейнера
Запустите контейнер с пробросом порта и монтированием папки `models`:
```bash
docker run -d -p 8000:8000 -v $(pwd)/models:/models ml_service
```

- `-p 8000:8000`: проброс порта 8000 для доступа к приложению.
- `-v $(pwd)/models:/models`: монтирование локальной папки `models` внутрь контейнера.

---

## Проверка работоспособности

### Доступ к сервису
После запуска контейнера сервис будет доступен по адресу:
```bash
http://localhost:8000
```

### Эндпоинты

#### **`GET /`**
Возвращает статус сервиса.
- Пример ответа:
  ```json
  {"status": "running"}
  ```

#### **`POST /api/prediction?item_id={id}`**
Выполняет предсказание для объекта.

- **URL-параметры:**
  - `item_id`: идентификатор объекта.

- **Тело запроса (JSON):**
  ```json
  {
    "Car_Name": "Honda Activa 4G",
    "Year": 2017,
    "Present_Price": 2.5,
    "Driven_kms": 4300,
    "Fuel_Type": "Petrol",
    "Selling_type": "Individual",
    "Transmission": "Automatic",
    "Owner": 0
  }
  ```

- **Пример успешного ответа:**
  ```json
  {
    "item_id": "1",
    "predict": 2.45
  }
  ```

---

## Пример тестирования

### Используя `curl`:
```bash
curl -X POST "http://localhost:8000/api/prediction?item_id=1" \\
-H "Content-Type: application/json" \\
-d '{
  "Car_Name": "Honda Activa 4G",
  "Year": 2017,
  "Present_Price": 2.5,
  "Driven_kms": 4300,
  "Fuel_Type": "Petrol",
  "Selling_type": "Individual",
  "Transmission": "Automatic",
  "Owner": 0
}'
```

